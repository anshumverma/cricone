<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Parser Tests</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Excel Parser Module Tests</h1>
    <div id="test-results"></div>

    <script src="app.js"></script>
    <script>
        // Test suite for Excel parser
        const testResults = [];

        function runTest(name, testFn) {
            try {
                const result = testFn();
                testResults.push({ name, passed: result.passed, message: result.message });
            } catch (error) {
                testResults.push({ name, passed: false, message: error.message });
            }
        }

        // Test 1: Column mapping detection
        runTest('Column Mapping Detection - Standard Headers', () => {
            const headers = ['Payer Name', 'Amount', 'Date', 'Campaign', 'Player Name'];
            const mapping = detectColumnMapping(headers);
            
            const passed = 
                mapping.payerName === 'Payer Name' &&
                mapping.paymentAmount === 'Amount' &&
                mapping.paymentDate === 'Date' &&
                mapping.membershipPlan === 'Campaign' &&
                mapping.playerName === 'Player Name';
            
            return {
                passed,
                message: passed ? 'All columns mapped correctly' : `Mapping failed: ${JSON.stringify(mapping)}`
            };
        });

        // Test 2: Column mapping with variations
        runTest('Column Mapping Detection - Zeffy Headers', () => {
            const headers = ['Donor Name', 'Total', 'Transaction Date', 'Item', 'Beneficiary'];
            const mapping = detectColumnMapping(headers);
            
            const passed = 
                mapping.payerName === 'Donor Name' &&
                mapping.paymentAmount === 'Total' &&
                mapping.paymentDate === 'Transaction Date' &&
                mapping.membershipPlan === 'Item' &&
                mapping.playerName === 'Beneficiary';
            
            return {
                passed,
                message: passed ? 'Zeffy-style columns mapped correctly' : `Mapping failed: ${JSON.stringify(mapping)}`
            };
        });

        // Test 3: Extract field function
        runTest('Extract Field - Valid String', () => {
            const row = { 'Name': 'John Doe' };
            const result = extractField(row, 'Name');
            const passed = result === 'John Doe';
            
            return {
                passed,
                message: passed ? 'Field extracted correctly' : `Expected "John Doe", got "${result}"`
            };
        });

        // Test 4: Extract field with whitespace
        runTest('Extract Field - Trim Whitespace', () => {
            const row = { 'Name': '  Jane Smith  ' };
            const result = extractField(row, 'Name');
            const passed = result === 'Jane Smith';
            
            return {
                passed,
                message: passed ? 'Whitespace trimmed correctly' : `Expected "Jane Smith", got "${result}"`
            };
        });

        // Test 5: Extract field - null handling
        runTest('Extract Field - Null Handling', () => {
            const row = { 'Name': null };
            const result = extractField(row, 'Name');
            const passed = result === null;
            
            return {
                passed,
                message: passed ? 'Null handled correctly' : `Expected null, got "${result}"`
            };
        });

        // Test 6: Extract amount - numeric
        runTest('Extract Amount - Numeric Value', () => {
            const row = { 'Amount': 100.50 };
            const result = extractAmount(row, 'Amount');
            const passed = result === 100.50;
            
            return {
                passed,
                message: passed ? 'Amount extracted correctly' : `Expected 100.50, got ${result}`
            };
        });

        // Test 7: Extract amount - string with currency
        runTest('Extract Amount - Currency String', () => {
            const row = { 'Amount': '$150.00' };
            const result = extractAmount(row, 'Amount');
            const passed = result === 150.00;
            
            return {
                passed,
                message: passed ? 'Currency symbol removed correctly' : `Expected 150.00, got ${result}`
            };
        });

        // Test 8: Extract amount - with commas
        runTest('Extract Amount - Comma Separator', () => {
            const row = { 'Amount': '1,250.75' };
            const result = extractAmount(row, 'Amount');
            const passed = result === 1250.75;
            
            return {
                passed,
                message: passed ? 'Comma removed correctly' : `Expected 1250.75, got ${result}`
            };
        });

        // Test 9: Extract date - string format
        runTest('Extract Date - String Format', () => {
            const row = { 'Date': '2024-01-15' };
            const result = extractDate(row, 'Date');
            const passed = result instanceof Date && !isNaN(result.getTime());
            
            return {
                passed,
                message: passed ? 'Date parsed correctly' : `Expected Date object, got ${result}`
            };
        });

        // Test 10: Extract date - Excel serial number
        runTest('Extract Date - Excel Serial Number', () => {
            const row = { 'Date': 45000 }; // Excel date serial
            const result = extractDate(row, 'Date');
            const passed = result instanceof Date && !isNaN(result.getTime());
            
            return {
                passed,
                message: passed ? `Date converted correctly: ${result}` : `Expected Date object, got ${result}`
            };
        });

        // Test 11: Validate record - complete
        runTest('Validate Record - Complete Record', () => {
            const record = {
                payerName: 'John Doe',
                paymentAmount: 100,
                paymentDate: new Date(),
                membershipPlan: 'Monthly'
            };
            const result = validateRecord(record);
            
            return {
                passed: result === true,
                message: result ? 'Complete record validated' : 'Complete record failed validation'
            };
        });

        // Test 12: Validate record - missing payer name
        runTest('Validate Record - Missing Payer Name', () => {
            const record = {
                payerName: null,
                paymentAmount: 100,
                paymentDate: new Date(),
                membershipPlan: 'Monthly'
            };
            const result = validateRecord(record);
            
            return {
                passed: result === false,
                message: result ? 'Should have failed validation' : 'Correctly flagged as incomplete'
            };
        });

        // Test 13: Validate record - zero amount
        runTest('Validate Record - Zero Amount', () => {
            const record = {
                payerName: 'John Doe',
                paymentAmount: 0,
                paymentDate: new Date(),
                membershipPlan: 'Monthly'
            };
            const result = validateRecord(record);
            
            return {
                passed: result === false,
                message: result ? 'Should have failed validation' : 'Correctly flagged as incomplete'
            };
        });

        // Test 14: Validate record - missing date
        runTest('Validate Record - Missing Date', () => {
            const record = {
                payerName: 'John Doe',
                paymentAmount: 100,
                paymentDate: null,
                membershipPlan: 'Monthly'
            };
            const result = validateRecord(record);
            
            return {
                passed: result === false,
                message: result ? 'Should have failed validation' : 'Correctly flagged as incomplete'
            };
        });

        // Test 15: Validate record - missing plan
        runTest('Validate Record - Missing Plan', () => {
            const record = {
                payerName: 'John Doe',
                paymentAmount: 100,
                paymentDate: new Date(),
                membershipPlan: null
            };
            const result = validateRecord(record);
            
            return {
                passed: result === false,
                message: result ? 'Should have failed validation' : 'Correctly flagged as incomplete'
            };
        });

        // Display results
        function displayResults() {
            const container = document.getElementById('test-results');
            const totalTests = testResults.length;
            const passedTests = testResults.filter(t => t.passed).length;
            
            let html = `<h2>Test Summary: ${passedTests}/${totalTests} Passed</h2>`;
            
            testResults.forEach(test => {
                html += `
                    <div class="test-section ${test.passed ? 'test-pass' : 'test-fail'}">
                        <div class="test-title">${test.passed ? '✓' : '✗'} ${test.name}</div>
                        <div>${test.message}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Run tests after page loads
        window.addEventListener('load', () => {
            displayResults();
        });
    </script>
</body>
</html>
