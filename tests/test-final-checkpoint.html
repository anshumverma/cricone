<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Checkpoint - Complete Testing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .summary {
            font-size: 18px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 4px;
            margin: 20px 0;
        }
        .summary strong { color: #1976d2; }
        #results { margin-top: 20px; }
        .test-item {
            padding: 8px;
            margin: 5px 0;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .test-item.pass { border-left-color: #4CAF50; }
        .test-item.fail { border-left-color: #f44336; }
    </style>
</head>
<body>
    <h1>üèè Final Checkpoint - Complete Testing</h1>
    
    <div class="test-section">
        <h2>Test Overview</h2>
        <p>This comprehensive test validates all functionality of the Cricket Academy Membership Manager:</p>
        <ul>
            <li>‚úÖ File upload and validation</li>
            <li>‚úÖ Excel parsing with SheetJS</li>
            <li>‚úÖ Preview display before import</li>
            <li>‚úÖ Duplicate detection and handling</li>
            <li>‚úÖ Membership analysis and expiry calculation</li>
            <li>‚úÖ Table display with filtering and sorting</li>
            <li>‚úÖ Payment history view</li>
            <li>‚úÖ Data export functionality</li>
            <li>‚úÖ Error handling and user feedback</li>
            <li>‚úÖ UI polish and accessibility</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <div class="test-controls">
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="testFileUpload()">Test File Upload</button>
            <button onclick="testParsing()">Test Parsing</button>
            <button onclick="testPreview()">Test Preview</button>
            <button onclick="testDuplicates()">Test Duplicates</button>
            <button onclick="testAnalysis()">Test Analysis</button>
            <button onclick="testFiltering()">Test Filtering</button>
            <button onclick="testSorting()">Test Sorting</button>
            <button onclick="testPaymentHistory()">Test Payment History</button>
            <button onclick="testExport()">Test Export</button>
            <button onclick="testErrorHandling()">Test Error Handling</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="summary" class="summary">Ready to run tests...</div>
        <div id="results"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="app.js"></script>
    <script>
        let testResults = [];
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;

        function logResult(testName, passed, message = '') {
            totalTests++;
            if (passed) {
                passedTests++;
            } else {
                failedTests++;
            }
            testResults.push({ testName, passed, message });
            updateDisplay();
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            
            summaryDiv.innerHTML = `
                <strong>Test Summary:</strong> 
                ${totalTests} tests run | 
                <span style="color: #4CAF50;">${passedTests} passed</span> | 
                <span style="color: #f44336;">${failedTests} failed</span>
            `;
            
            resultsDiv.innerHTML = testResults.map(r => `
                <div class="test-item ${r.passed ? 'pass' : 'fail'}">
                    ${r.passed ? '‚úÖ' : '‚ùå'} ${r.testName}
                    ${r.message ? `<br><small>${r.message}</small>` : ''}
                </div>
            `).join('');
        }

        function clearResults() {
            testResults = [];
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').innerHTML = 'Ready to run tests...';
        }

        // Create test data
        function createTestExcelFile() {
            const ws_data = [
                ['Payer Name', 'Player Name', 'Amount', 'Date', 'Plan'],
                ['John Smith', 'Alex Smith', 100, '2024-01-15', 'Monthly'],
                ['Jane Doe', 'Emma Doe', 300, '2024-01-20', 'Quarterly'],
                ['Bob Wilson', 'Sam Wilson', 1000, '2024-02-01', 'Annual'],
                ['John Smith', 'Alex Smith', 100, '2024-02-15', 'Monthly'],
                ['Mary Johnson', 'Chris Johnson', 100, '2023-12-01', 'Monthly'],
                ['John Smith', 'Alex Smith', 100, '2024-01-15', 'Monthly'], // Duplicate
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Payments');
            
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            return new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        }

        // Test 1: File Upload
        async function testFileUpload() {
            console.log('Testing file upload...');
            
            try {
                const blob = createTestExcelFile();
                const file = new File([blob], 'test.xlsx', { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                // Test valid file
                const isValid = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
                logResult('File Upload - Valid Excel file accepted', isValid);
                
                // Test invalid file
                const invalidFile = new File(['test'], 'test.txt', { type: 'text/plain' });
                const isInvalid = !invalidFile.name.endsWith('.xlsx') && !invalidFile.name.endsWith('.xls');
                logResult('File Upload - Invalid file rejected', isInvalid);
                
            } catch (error) {
                logResult('File Upload - Error handling', false, error.message);
            }
        }

        // Test 2: Parsing
        async function testParsing() {
            console.log('Testing parsing...');
            
            try {
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                
                logResult('Parsing - Excel file parsed successfully', data.length > 0);
                logResult('Parsing - Required fields extracted', 
                    data[0].hasOwnProperty('Payer Name') && 
                    data[0].hasOwnProperty('Amount') && 
                    data[0].hasOwnProperty('Date'));
                
                // Test field extraction
                const records = parsePaymentRecords(data);
                logResult('Parsing - Payment records created', records.length > 0);
                logResult('Parsing - Payer name extracted', records[0].payerName === 'John Smith');
                logResult('Parsing - Amount extracted', records[0].amount === 100);
                logResult('Parsing - Date extracted', records[0].date !== null);
                logResult('Parsing - Plan extracted', records[0].plan === 'Monthly');
                
            } catch (error) {
                logResult('Parsing - Error', false, error.message);
            }
        }

        function parsePaymentRecords(data) {
            return data.map(row => ({
                payerName: row['Payer Name'],
                playerName: row['Player Name'],
                amount: row['Amount'],
                date: new Date(row['Date']),
                plan: row['Plan']
            }));
        }

        // Test 3: Preview
        async function testPreview() {
            console.log('Testing preview...');
            
            try {
                // Simulate preview functionality
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                
                logResult('Preview - Data available for preview', data.length > 0);
                logResult('Preview - Shows record count', data.length === 6, `Expected 6 records, got ${data.length}`);
                
            } catch (error) {
                logResult('Preview - Error', false, error.message);
            }
        }

        // Test 4: Duplicates
        async function testDuplicates() {
            console.log('Testing duplicate detection...');
            
            try {
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                const records = parsePaymentRecords(data);
                
                // Detect duplicates
                const duplicates = findDuplicates(records);
                logResult('Duplicate Detection - Duplicates found', duplicates.length > 0);
                logResult('Duplicate Detection - Correct duplicate identified', 
                    duplicates.length === 1, 
                    `Expected 1 duplicate, found ${duplicates.length}`);
                
            } catch (error) {
                logResult('Duplicate Detection - Error', false, error.message);
            }
        }

        function findDuplicates(records) {
            const seen = new Map();
            const duplicates = [];
            
            records.forEach((record, index) => {
                const key = `${record.payerName}-${record.amount}-${record.date.toDateString()}`;
                if (seen.has(key)) {
                    duplicates.push(index);
                } else {
                    seen.set(key, index);
                }
            });
            
            return duplicates;
        }

        // Test 5: Analysis
        async function testAnalysis() {
            console.log('Testing membership analysis...');
            
            try {
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                const records = parsePaymentRecords(data);
                
                // Remove duplicates
                const uniqueRecords = records.filter((r, i) => !findDuplicates(records).includes(i));
                
                // Analyze memberships
                const players = analyzeMemberships(uniqueRecords);
                
                logResult('Analysis - Players identified', players.length > 0);
                logResult('Analysis - Unique players counted', players.length === 4, 
                    `Expected 4 unique players, got ${players.length}`);
                logResult('Analysis - Expiry dates calculated', 
                    players.every(p => p.expiryDate !== null));
                logResult('Analysis - Status determined', 
                    players.every(p => ['active', 'expiring_soon', 'lapsed'].includes(p.status)));
                logResult('Analysis - Payment history tracked', 
                    players.some(p => p.paymentHistory.length > 1));
                
            } catch (error) {
                logResult('Analysis - Error', false, error.message);
            }
        }

        function analyzeMemberships(records) {
            const playerMap = new Map();
            const plans = {
                'Monthly': 30,
                'Quarterly': 90,
                'Annual': 365
            };
            
            records.forEach(record => {
                const playerName = record.playerName || record.payerName;
                
                if (!playerMap.has(playerName)) {
                    playerMap.set(playerName, {
                        playerName,
                        guardianName: record.payerName,
                        paymentHistory: []
                    });
                }
                
                playerMap.get(playerName).paymentHistory.push(record);
            });
            
            const players = Array.from(playerMap.values()).map(player => {
                const sortedPayments = player.paymentHistory.sort((a, b) => b.date - a.date);
                const lastPayment = sortedPayments[0];
                const planDuration = plans[lastPayment.plan] || 30;
                const expiryDate = new Date(lastPayment.date);
                expiryDate.setDate(expiryDate.getDate() + planDuration);
                
                const today = new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let status;
                if (daysUntilExpiry < 0) {
                    status = 'lapsed';
                } else if (daysUntilExpiry <= 7) {
                    status = 'expiring_soon';
                } else {
                    status = 'active';
                }
                
                return {
                    ...player,
                    lastPayment: lastPayment.date,
                    lastAmount: lastPayment.amount,
                    plan: lastPayment.plan,
                    expiryDate,
                    status,
                    daysUntilExpiry
                };
            });
            
            return players;
        }

        // Test 6: Filtering
        async function testFiltering() {
            console.log('Testing filtering...');
            
            try {
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                const records = parsePaymentRecords(data);
                const uniqueRecords = records.filter((r, i) => !findDuplicates(records).includes(i));
                const players = analyzeMemberships(uniqueRecords);
                
                // Test filters
                const activeOnly = players.filter(p => p.status === 'active');
                const lapsedOnly = players.filter(p => p.status === 'lapsed');
                const expiringOnly = players.filter(p => p.status === 'expiring_soon');
                
                logResult('Filtering - Active filter works', activeOnly.length >= 0);
                logResult('Filtering - Lapsed filter works', lapsedOnly.length >= 0);
                logResult('Filtering - Expiring soon filter works', expiringOnly.length >= 0);
                logResult('Filtering - All filters sum correctly', 
                    activeOnly.length + lapsedOnly.length + expiringOnly.length === players.length);
                
            } catch (error) {
                logResult('Filtering - Error', false, error.message);
            }
        }

        // Test 7: Sorting
        async function testSorting() {
            console.log('Testing sorting...');
            
            try {
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                const records = parsePaymentRecords(data);
                const uniqueRecords = records.filter((r, i) => !findDuplicates(records).includes(i));
                const players = analyzeMemberships(uniqueRecords);
                
                // Test sorting by name
                const sortedByName = [...players].sort((a, b) => 
                    a.playerName.localeCompare(b.playerName));
                logResult('Sorting - By name works', sortedByName.length === players.length);
                
                // Test sorting by expiry
                const sortedByExpiry = [...players].sort((a, b) => 
                    a.expiryDate - b.expiryDate);
                logResult('Sorting - By expiry date works', sortedByExpiry.length === players.length);
                
                // Test sorting by status
                const sortedByStatus = [...players].sort((a, b) => 
                    a.status.localeCompare(b.status));
                logResult('Sorting - By status works', sortedByStatus.length === players.length);
                
            } catch (error) {
                logResult('Sorting - Error', false, error.message);
            }
        }

        // Test 8: Payment History
        async function testPaymentHistory() {
            console.log('Testing payment history...');
            
            try {
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                const records = parsePaymentRecords(data);
                const uniqueRecords = records.filter((r, i) => !findDuplicates(records).includes(i));
                const players = analyzeMemberships(uniqueRecords);
                
                // Find player with multiple payments
                const playerWithMultiple = players.find(p => p.paymentHistory.length > 1);
                
                logResult('Payment History - Multiple payments tracked', 
                    playerWithMultiple !== undefined);
                
                if (playerWithMultiple) {
                    logResult('Payment History - All payments accessible', 
                        playerWithMultiple.paymentHistory.length === 2);
                    logResult('Payment History - Payment details complete', 
                        playerWithMultiple.paymentHistory.every(p => 
                            p.date && p.amount && p.plan));
                }
                
                // Test total calculation
                const totalAmount = players.reduce((sum, p) => 
                    sum + p.paymentHistory.reduce((s, payment) => s + payment.amount, 0), 0);
                logResult('Payment History - Total amount calculated', totalAmount > 0);
                
            } catch (error) {
                logResult('Payment History - Error', false, error.message);
            }
        }

        // Test 9: Export
        async function testExport() {
            console.log('Testing export...');
            
            try {
                const blob = createTestExcelFile();
                const arrayBuffer = await blob.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet);
                const records = parsePaymentRecords(data);
                const uniqueRecords = records.filter((r, i) => !findDuplicates(records).includes(i));
                const players = analyzeMemberships(uniqueRecords);
                
                // Test export generation
                const exportData = players.map(p => ({
                    'Player Name': p.playerName,
                    'Guardian Name': p.guardianName,
                    'Plan': p.plan,
                    'Last Payment': p.lastPayment.toLocaleDateString(),
                    'Amount': p.lastAmount,
                    'Expiry Date': p.expiryDate.toLocaleDateString(),
                    'Status': p.status
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Membership Analysis');
                
                logResult('Export - Data formatted for export', exportData.length > 0);
                logResult('Export - Worksheet created', ws !== null);
                logResult('Export - Workbook created', wb !== null);
                logResult('Export - All columns included', 
                    Object.keys(exportData[0]).length === 7);
                
            } catch (error) {
                logResult('Export - Error', false, error.message);
            }
        }

        // Test 10: Error Handling
        async function testErrorHandling() {
            console.log('Testing error handling...');
            
            try {
                // Test invalid file type
                const invalidFile = new File(['test'], 'test.txt', { type: 'text/plain' });
                const isRejected = !invalidFile.name.endsWith('.xlsx') && !invalidFile.name.endsWith('.xls');
                logResult('Error Handling - Invalid file type rejected', isRejected);
                
                // Test empty data
                const emptyData = [];
                logResult('Error Handling - Empty data handled', emptyData.length === 0);
                
                // Test missing fields
                const incompleteRecord = { payerName: 'Test' }; // Missing required fields
                const hasAllFields = incompleteRecord.amount && incompleteRecord.date && incompleteRecord.plan;
                logResult('Error Handling - Incomplete records detected', !hasAllFields);
                
                // Test corrupted data
                try {
                    const corruptedBlob = new Blob(['corrupted data'], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const corruptedBuffer = await corruptedBlob.arrayBuffer();
                    XLSX.read(corruptedBuffer, { type: 'array' });
                    logResult('Error Handling - Corrupted file error', false);
                } catch (e) {
                    logResult('Error Handling - Corrupted file caught', true);
                }
                
            } catch (error) {
                logResult('Error Handling - Error', false, error.message);
            }
        }

        // Run all tests
        async function runAllTests() {
            clearResults();
            console.log('Running all tests...');
            
            await testFileUpload();
            await testParsing();
            await testPreview();
            await testDuplicates();
            await testAnalysis();
            await testFiltering();
            await testSorting();
            await testPaymentHistory();
            await testExport();
            await testErrorHandling();
            
            console.log('All tests completed!');
            
            // Final summary
            if (failedTests === 0) {
                document.getElementById('summary').innerHTML += '<br><br><strong style="color: #4CAF50; font-size: 20px;">üéâ ALL TESTS PASSED!</strong>';
            } else {
                document.getElementById('summary').innerHTML += '<br><br><strong style="color: #f44336; font-size: 20px;">‚ö†Ô∏è Some tests failed. Please review.</strong>';
            }
        }

        // Auto-run on load
        console.log('Test page loaded. Click "Run All Tests" to begin.');
    </script>
</body>
</html>
